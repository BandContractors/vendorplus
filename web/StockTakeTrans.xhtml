<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:p="http://primefaces.org/ui">
    <h:head>
        <title>Stock Take</title>
        <link href="resources/images/sys_icon.ico" rel="shortcut icon" type="image/x-icon" />         <link rel="stylesheet" type="text/css" href="style.css?ln=css"/>
        <script  language="javascript">
            function confirmDelete()
            {
                return confirm('Are you sure you want to delete this current record?');
            }
            function alertSave()
            {
                return alert('Record saved successfully!');
            }
        </script> 
    </h:head>
    <f:metadata>
        <f:viewAction action="#{transBean.initTransType(generalUserSetting.currentTransactionTypeId,generalUserSetting.currentTransactionReasonId)}"/>
        <f:viewAction action="#{stock_take_sessionBean.clearStock_take_session(stock_take_session)}"/>
        <f:viewAction action="#{utilityBean.clearList(stock_take_sessionBean.stock_take_sessionObjectList)}"/>
        <f:viewAction action="#{utilityBean.clearList(stock_take_session_itemBean.stock_take_session_itemObjectList)}"/>
        <f:viewAction action="#{stock_take_sessionBean.resetStock_take_session(stock_take_sessionBean,itemBean.selectedItem)}"/>
    </f:metadata>
    <f:event listener="#{navigationBean.checkAccessDenied('128', 'View')}" type="preRenderView" />
    <h:body>
        <ui:include src="Menu.xhtml"/>
        <h:form id="formMain">

            <h:panelGrid styleClass="clsPanelReportFilterTitle" columns="1">
                <h:outputLabel styleClass="clsLabelReportFilterTitle" id="olbldiscountPackageHeader" value="#{langsys['Stock']} #{langsys['Take']}"/>
            </h:panelGrid>

            <h:panelGrid id="pnlgInput" styleClass="clsPanelReportFilter" columns="8">
                <h:outputLabel  value="#{langsys['From']}"/>
                <p:commandLink value="#{langsys['Session']}" action="#{itemBean.displayUNSPSC()}" oncomplete="PF('sbarSession').show()" update="formMain:pnlgSession"/>
                <h:outputLabel  value="#{langsys['Category']}"/>
                <h:outputLabel  value="#{langsys['Subcategory']}"/>
                <h:outputLabel  value="#{langsys['Item']} #{langsys['Description']}"/>
                <h:outputLabel  value=""/>
                <h:outputLabel  value=""/>
                <h:outputLabel  value=""/>

                <h:inputText disabled="true" value="#{generalUserSetting.getCurrentStore().getStoreName()}" style="width: 120px;height: 24px;"/>
                <h:selectOneMenu id="menuSession" value="#{stock_take_sessionBean.stock_take_session_id}" style="width: 200px;height: 30px;">
                    <f:selectItem itemLabel="" itemValue="0"/>
                    <f:selectItems value="#{stock_take_sessionBean.getOpenStock_take_sessionList()}" var="ss" itemLabel="#{ss.add_by} #{utilityBean.formatDateTime(ss.start_time)} #{langsys['Notes']}:#{ss.notes}" itemValue="#{ss.stock_take_session_id}"/>
                </h:selectOneMenu>
                <h:selectOneMenu id="menuCategory" value="#{stock_take_sessionBean.category_id}" style="width: 200px;height: 30px;">
                    <f:selectItem itemLabel="" itemValue="0"/>
                    <f:selectItems value="#{categoryBean.categoriesStockTake}" var="c" itemLabel="#{c.categoryName}" itemValue="#{c.categoryId}"/>
                    <f:ajax event="change" render="menuSubCategory"/>
                </h:selectOneMenu>
                <h:selectOneMenu id="menuSubCategory" value="#{stock_take_sessionBean.subcategory_id}" style="width: 200px;height: 30px;">
                    <f:selectItem itemLabel="" itemValue="0"/>
                    <f:selectItems value="#{subCategoryBean.getSubCategoriesByCategoryId(stock_take_sessionBean.category_id)}" var="s" itemLabel="#{s.subCategoryName}" itemValue="#{s.subCategoryId}"/>
                </h:selectOneMenu>
                <p:autoComplete id="autcItem" widgetVar="WautcItem" value="#{itemBean.selectedItem}"  
                                completeMethod="#{itemBean.getItemObjectListActive}" 
                                var="itm" 
                                itemLabel="#{itm.description}" 
                                itemValue="#{itm}" 
                                converter="ItemConverter" style="text-align: left" 
                                forceSelection="true" queryDelay="0" 
                                onkeypress="if (event.keyCode == 13) {
                                            doAddClick();
                                            return false;
                                        }" >
                    <p:column headerText="#{langsys['Item']} #{langsys['Description']}" style="text-align: left" >  
                        #{itm.description} 
                    </p:column>
                    <p:column headerText="#{langsys['Alias']}" style="text-align: left" >  
                        #{itm.alias_name} 
                    </p:column>
                    <p:column headerText="#{langsys['Item']} #{langsys['Code']}" style="text-align: left" >  
                        #{itm.itemCode} 
                    </p:column>
                    <p:column headerText="#{langsys['Retail']} #{langsys['Sale']} #{langsys['Price']}" style="text-align: left">  
                        <h:outputText value="#{itm.unitRetailsalePrice}">
                            <f:convertNumber pattern="###,###,###.########" locale="#{utilityBean.convertLocaleToString()}"/>
                        </h:outputText>
                    </p:column>
                    <p:column headerText="#{langsys['Wholesale']} #{langsys['Price']}" style="text-align: left" rendered="#{generalUserSetting.currentTransactionReasonId==2 or generalUserSetting.currentTransactionReasonId==10}">
                        <h:outputText value="#{itm.unitWholesalePrice}">
                            <f:convertNumber pattern="###,###,###.########" locale="#{utilityBean.convertLocaleToString()}"/>
                        </h:outputText>
                    </p:column>
                    <p:column headerText="#{langsys['Special']} #{langsys['Price']}" style="text-align: left" rendered="#{generalUserSetting.currentTransactionReasonId==103}">
                        <h:outputText value="#{itm.unit_special_price}">
                            <f:convertNumber pattern="###,###,###.########" locale="#{utilityBean.convertLocaleToString()}"/>
                        </h:outputText>
                    </p:column>
                    <p:column headerText="#{langsys['Currency']}" style="text-align: left">
                        <h:outputText value="#{itm.currencyCode}">
                        </h:outputText>
                    </p:column>
                    <p:ajax event="itemSelect" listener="#{stock_take_sessionBean.setItem_id(itemBean.selectedItem.itemId)}"/>
                    <p:ajax event="change" listener="#{stock_take_sessionBean.setItem_id(itemBean.selectedItem.itemId)}" rendered="#{itemBean.selectedItem!=null}"/>
                </p:autoComplete>
                <p:commandButton id="cbtnGetA" value="#{langsys['All']}"  icon="ui-icon-arrowrefresh-1-s" onclick="PF('statusDialog').show()" onsuccess="PF('statusDialog').hide()">
                    <p:dialog widgetVar="statusDialog" height="100" position="center" modal="true" draggable="false" closable="false" resizable="false" showHeader="false">
                        <p:graphicImage name="/images/ajax-loader.gif"/>
                    </p:dialog>
                    <p:ajax listener="#{stock_take_sessionBean.getStock_take_session_itemList(stock_take_sessionBean,stock_take_session_itemBean.stock_take_session_itemObjectList,0)}" process="pnlgInput" update="dtblList growl1"/>
                </p:commandButton>
                <p:commandButton id="cbtnGetC" value="#{langsys['Counted']}"  icon="ui-icon-arrowrefresh-1-s" onclick="PF('statusDialog').show()" onsuccess="PF('statusDialog').hide()">
                    <p:dialog widgetVar="statusDialog" height="100" position="center" modal="true" draggable="false" closable="false" resizable="false" showHeader="false">
                        <p:graphicImage name="/images/ajax-loader.gif"/>
                    </p:dialog>
                    <p:ajax listener="#{stock_take_sessionBean.getStock_take_session_itemList(stock_take_sessionBean,stock_take_session_itemBean.stock_take_session_itemObjectList,2)}" process="pnlgInput" update="dtblList growl1"/>
                </p:commandButton>
                <p:commandButton id="cbtnGetU" value="#{langsys['Uncounted']}"  icon="ui-icon-arrowrefresh-1-s" onclick="PF('statusDialog').show()" onsuccess="PF('statusDialog').hide()">
                    <p:dialog widgetVar="statusDialog" height="100" position="center" modal="true" draggable="false" closable="false" resizable="false" showHeader="false">
                        <p:graphicImage name="/images/ajax-loader.gif"/>
                    </p:dialog>
                    <p:ajax listener="#{stock_take_sessionBean.getStock_take_session_itemList(stock_take_sessionBean,stock_take_session_itemBean.stock_take_session_itemObjectList,1)}" process="pnlgInput" update="dtblList growl1"/>
                </p:commandButton>
            </h:panelGrid>
            <p:growl id="growl1"/>
            <p:dataTable id="dtblList" value="#{stock_take_session_itemBean.stock_take_session_itemObjectList}" var="i" 
                         tableStyle="width:auto;" rowIndexVar="rowIndex" rowStyleClass="#{i.stock_take_session_item_id eq 0 ? 'black' : 'amber'}"
                         >
                <p:column headerText="#">
                    <h:outputLabel value="#{rowIndex+1}"/>
                </p:column>
                <p:column headerText="#{langsys['Description']}">
                    <h:outputLabel value="#{i.description}"/>
                </p:column>
                <p:column headerText="#{langsys['Batch']}">
                    <h:outputLabel value="#{i.batchno}"/>
                </p:column>
                <p:column headerText="#{langsys['Specific']} #{langsys['Name']}">
                    <h:outputLabel value="#{i.desc_specific}"/>
                </p:column>
                <p:column headerText="#{langsys['Specific']} #{langsys['Code']}">
                    <h:outputLabel value="#{i.code_specific}"/>
                </p:column>
                <p:column headerText="#{langsys['Unit']}">
                    <h:outputLabel value="#{i.unit_symbol}"/>
                </p:column>
                <p:column headerText="#{langsys['Qty']} #{langsys['System']}" style="text-align: right;">
                    <h:outputLabel value="#{utilityBean.formatDoubleToStringByDp(i.qty_system,8)}"/>
                </p:column>
                <p:column headerText="#{langsys['Qty']} #{langsys['Counted']}" style="text-align: right;">
                    <h:inputText value="#{i.qty_physical}" style="width: 100px;" disabled="#{i.stock_take_session_item_id gt 0}">
                        <f:convertNumber pattern="###,###,###.#############" locale="#{utilityBean.convertLocaleToString()}"/>
                        <f:ajax event="change" listener="#{stock_take_session_itemBean.changeQtyCounted(i)}" execute="dtblList" render="olblShort olblOver"/>
                    </h:inputText>
                </p:column>
                <p:column headerText="#{langsys['Qty']} #{langsys['Short']}" style="text-align: right;">
                    <h:outputLabel id="olblShort" value="#{utilityBean.formatDoubleToStringByDp(i.qty_short,8)}"/>
                </p:column>
                <p:column headerText="#{langsys['Qty']} #{langsys['Over']}" style="text-align: right;">
                    <h:outputLabel id="olblOver" value="#{utilityBean.formatDoubleToStringByDp(i.qty_over,8)}"/>
                </p:column>
                <p:column exportable="false">
                    <p:commandButton value="#{langsys['Save']} #{langsys['Only']}" id="cmdbAction1" title="Save Only, Do not Adjust" rendered="#{menuItemBean.menuItemObj.STOCKTAKE_ACTION eq 2 and i.stock_take_session_item_id eq 0}" onclick="PF('statusDialog2').show()" onsuccess="PF('statusDialog2').hide()">
                        <p:dialog widgetVar="statusDialog2" height="100" position="center" modal="true" draggable="false" closable="false" resizable="false" showHeader="false">
                            <p:graphicImage name="/images/ajax-loader.gif"/>
                        </p:dialog>
                        <p:ajax listener="#{stock_take_sessionBean.saveStock_take_session_itemCall(i,2)}" update="dtblList :formMain:growl1"/>
                    </p:commandButton>
                    <p:commandButton value="#{langsys['Save']} &amp; #{langsys['Adjust']}" id="cmdbAction2" title="Save and Adjust" rendered="#{menuItemBean.menuItemObj.STOCKTAKE_ACTION eq 1 and i.stock_take_session_item_id eq 0}" onclick="PF('statusDialog3').show()" onsuccess="PF('statusDialog3').hide()">
                        <p:dialog widgetVar="statusDialog3" height="100" position="center" modal="true" draggable="false" closable="false" resizable="false" showHeader="false">
                            <p:graphicImage name="/images/ajax-loader.gif"/>
                        </p:dialog>
                        <p:ajax listener="#{stock_take_sessionBean.saveStock_take_session_itemCall(i,1)}" update="dtblList :formMain:growl1"/>
                    </p:commandButton>
                </p:column>
            </p:dataTable>
            <p:sidebar widgetVar="sbarSession" position="bottom" baseZIndex="10000" style="height: 600px;">
                <h:panelGrid id="pnlgSession" columns="1" style="text-align: center;">
                    <h:panelGrid columns="5">
                        <h:outputLabel value="#{langsys['From']}:"/>
                        <h:inputText disabled="true" value="#{generalUserSetting.getCurrentStore().getStoreName()}" style="width: 120px;height: 24px;"/>
                        <h:outputLabel value="#{langsys['Stock']} #{langsys['Take']} #{langsys['Notes']}:"/>
                        <h:inputText value="#{stocktake_session.notes}" style="height: 24px;"/>
                        <p:commandButton value="#{langsys['Start']} #{langsys['New']} #{langsys['Stock']} #{langsys['Take']} #{langsys['Session']}" icon="ui-icon-plus" actionListener="#{stock_take_sessionBean.insertStock_take_sessionCall(stocktake_session)}" update="formMain:tblSession :formMain:menuSession formMain:growl2"/>
                    </h:panelGrid>
                    <p:dataTable id="tblSession" rowIndexVar="rowIndex" tableStyle="width:auto;" var="ss" value="#{stock_take_sessionBean.getStock_take_sessionList(generalUserSetting.currentStore.storeId,50)}" 
                                 rowStyleClass="#{ss.is_closed eq 0 ? 'amber' : 'red'}"
                                 >
                        <p:column headerText="#" style="text-align: left;font-size: 14px;">
                            <h:outputText value="#{rowIndex+1} "/>
                        </p:column>
                        <p:column headerText="#{langsys['ID']}" style="text-align: left;font-size: 14px;">
                            <h:outputText value="#{ss.stock_take_session_id}"/>
                        </p:column>
                        <p:column headerText="#{langsys['Notes']}" style="text-align: left;font-size: 14px;">
                            <h:outputText value="#{ss.notes}"/>
                        </p:column>
                        <p:column headerText="#{langsys['Opened']} #{langsys['By']}" style="text-align: left;font-size: 14px;">
                            <h:outputText value="#{ss.add_by}"/>
                        </p:column>
                        <p:column headerText="#{langsys['Open']} #{langsys['Date']}" style="text-align: left;font-size: 14px;">
                            <h:outputText value="#{utilityBean.formatDateTime(ss.start_time)}"/>
                        </p:column>
                        <p:column headerText="#{langsys['Close']} #{langsys['Date']}" style="text-align: left;font-size: 14px;">
                            <h:outputText value="#{utilityBean.formatDateTime(ss.end_time)}"/>
                        </p:column>
                        <p:column headerText="#{langsys['Last']} #{langsys['Updated']} #{langsys['By']}" style="text-align: left;font-size: 14px;">
                            <h:outputText value="#{ss.last_update_by}"/>
                        </p:column>
                        <p:column headerText="#{langsys['Available']}" style="text-align: left;font-size: 14px;">
                            <h:outputText value="#{utilityBean.formatDoubleToString(ss.stock_items_available)}"/>
                        </p:column>
                        <p:column headerText="#{langsys['Counted']}" style="text-align: left;font-size: 14px;">
                            <h:outputText value="#{utilityBean.formatDoubleToString(ss.stock_items_counted)}"/>
                        </p:column>
                        <p:column headerText="#{langsys['Status']}" style="text-align: left;font-size: 14px;">
                            <h:outputText value="Open" rendered="#{ss.is_closed eq 0}"/>
                            <h:outputText value="Closed" rendered="#{ss.is_closed eq 1}"/>
                        </p:column>
                        <p:column exportable="false" headerText="" style="text-align: left;font-size: 14px;">
                            <p:commandButton icon="ui-icon-closethick" actionListener="#{stock_take_sessionBean.closeStock_take_sessionCall(ss)}" update=":formMain:tblSession :formMain:menuSession :formMain:growl2" title="Close Stock Take Session"  rendered="#{ss.is_closed eq 0}"/>
                        </p:column>
                    </p:dataTable>
                </h:panelGrid>
                <p:growl id="growl2"/>
            </p:sidebar>
        </h:form>
    </h:body>
</html>

